# 流控规则 {#concept_101077_zh .concept}

流控，即流量控制，是 AHAS 提供的一种应用高可用防护能力。其原理是监控应用流量的 QPS或线程数等指标，当达到您指定的阈值时立即拦截流量，以避免被瞬时的流量高峰冲垮，从而保障您的应用高可用性。

## 背景信息 {#section_ngh_mfd_kgb .section}

流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的，因此就需要根据系统的处理能力对流量进行控制。

流量控制有以下几个角度：

-   运行指标：例如 QPS、线程数等；
-   资源的调用关系：例如请求来源、资源的调用链路，资源和资源之间的关联关系等；
-   控制的效果：例如直接限流、Warm Up（预热/冷启动）、排队等待等。

您可以自由选择控制的角度，并进行灵活组合，从而达到想要的效果。

## 功能入口 { .section}

1.  登录 [AHAS 控制台](https://ahas.console.aliyun.com/)。

2.  在 AHAS 控制台左上角，选择应用接入的**地域**。

3.  在左侧导航栏，单击**流控降级**。

4.  单击要配置流控规则的目标应用卡片，进入该应用的监控详情。

5.  您可以选择以下任意一个入口，进入新建流控规则页面：

    -   在**监控详情**页面，单击资源卡片右上角的加号图标，选择**流控规则**页签，单击**新建流控规则**。
    -   在左侧导航栏，选择**请求链路**，单击目标资源**操作**栏中的流控图标。
    -   在左侧导航栏，选择**流控规则**。单击右上角**新建流控规则**。

## 新建流控规则 {#section_yks_qfd_kgb .section}

**说明：** 请务必在 AHAS 控制台左上角选择应用接入的**地域**，否则无法获取应用数据。

1.  在新建流控规则对话框中，填写资源名称，即适用该规则的应用资源。

    ![](https://aliware-images.oss-cn-hangzhou.aliyuncs.com/ahas/db_create_traffic_control_rule.png)

2.  填写流控应用，即该规则针对的来源应用（调用该资源的调用方标识），规则启用后，将按照调用来源进行流控。例如，在 Dubbo 中，此处即填入对应的 Dubbo Consumer 的应用名称。

    默认来源应用设为 `default`，代表不区分来源应用。

3.   ** **阈值类型** **：选择以 ** **QPS** ** 或** **线程数** **作为阈值。**线程数**是指按照资源的并发线程数（即该资源正在执行的线程数）进行流量控制。

    规则开启时，接口流量将控制在该阈值以内。

4.   ** **流控模式** **：选择根据何种资源调用关系进行流控。

    -    ** **直接** **：直接控制来自**流控应用**中调用来源的访问流量；如果**流控应用**为 `default` 则不区分调用来源。
    -    ** **关联** **：控制当前资源的关联资源的流量。

        例如，read\_db 和 write\_db 这两个资源分别代表数据库读写。可以给 read\_db 设置限流规则来达到写优先的目的：设置 **关联资源** 为 write\_db。这样当写库操作过于频繁时，读数据的请求会被限流。

    -    ** **链路** **：控制该资源所在的调用链路的入口流量。需要在规则中配置 **入口资源**，即该调用链路入口的上下文名称。

5.   ** **流控方式** **：当**阈值类型**为**QPS**时，选择如何处理被拦截的流量。

    -    **快速失败**：达到阈值时，立即拦截请求。

    -    **Warm Up**：需设置具体的预热时间。

        如果系统在此之前长期处于空闲的状态，当流量突然增大的时候，该方式会让处理请求的速率缓慢增加，经过设置的预热时间以后，到达系统处理请求速率的设定值。

        默认会从设置的 QPS 阈值的 1/3 开始慢慢往上增加至 QPS 设置值。

    -    **排队等待**：请求匀速通过，允许排队等待，通常用于消息队列削峰填谷等场景。需设置具体的超时时间，达到超时时间后请求会失败。

        例如，QPS 配置为 5，则代表请求每 200 ms 才能通过一个，多出的请求将排队等待通过。超时时间代表最大排队时间，超出最大排队时间的请求将会直接被拒绝。

         **注：** 排队等待模式下，QPS 设置值不要超过 1000（请求间隔 1 ms）。

6.   ** **是否开启** **：打开开关表示启用该规则，关闭开关表示禁用该规则。

7.  单击**新建**，完成流控规则的创建。

    新增的规则将出现在**流控规则**页面。


## 管理流控规则 {#section_dls_qfd_kgb .section}

在**流控规则**页面，您可以启用、禁用、编辑或删除流控规则。

-   单流控规则启用/禁用：

    在**流控规则**页面，找到目标资源下对应的流控规则，单击**状态**栏的启用开关，可快速启用或禁用该规则。

-   多流控规则批量启用/禁用：

    在**流控规则**页面，勾选多个流控规则，单击**批量启用**或**批量禁用**，可快速启用或禁用多个规则。

-   编辑规则：

    在**流控规则**页面，找到目标资源下对应的流控规则，单击**操作**栏的**编辑**，可修改该规则的相关信息。

-   删除规则：

    在**流控规则**页面，找到目标资源下对应的流控规则，单击**操作**栏的**删除**。


