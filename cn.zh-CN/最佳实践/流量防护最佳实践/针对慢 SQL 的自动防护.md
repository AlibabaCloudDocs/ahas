# 针对慢 SQL 的自动防护

慢 SQL 是比较致命的影响系统稳定性的因素之一。针对此类场景，AHAS 应用防护提供了 SQL 级别的识别与防护，您可以根据监控详情为慢 SQL 配置流控降级规则保障系统的稳定性。

## 背景信息

系统中出现慢 SQL 可能会导致 CPU、负载异常和系统资源耗尽等情况。严重的慢 SQL 发生后可能会拖垮整个数据库，对线上业务产生阻断性的风险。线上生产环境出现慢 SQL 可能原因如下：

-   网络速度慢、内存不足、I/O 吞吐量小、磁盘空间被占满等硬件原因。
-   没有索引或者索引失效。
-   系统数据过多。
-   在项目初期没有对 SQL 的性能做好考量。

使用 AHAS 应用防护识别慢 SQL 并为其配置流控降级规则的具体操作流程如下：





## 步骤一：接入 AHAS 应用防护

AHAS 应用防护通过自动检测常见的 DAO 类、JDBC 驱动类等自动识别应用中的 SQL 语句，用户可以通过 Java Agent 或者 JAVA SDK 两种接入方式来实现对 SQL 的监控和拦截。

**说明：** 其中 Java Agent接入方式目前支持 MySQL JDBC 和 Oracle JDBC 驱动，SDK 接入方式目前支持 MyBatis 框架下的 SQL 识别。第三方组件和框架的版本支持情况详见[支持组件列表](/cn.zh-CN/流量防护/应用防护/支持组件列表.md)。

将应用接入 AHAS 请参见[接入应用概述](/cn.zh-CN/流量防护/应用防护/接入应用/接入应用概述.md)。

## 步骤二：查看监控

将应用接入 AHAS 应用防护服务后，您可以监控应用和资源 API 维度的实时数据（细化至秒级），从而评估系统的整体表现，并为流控降级规则的配置提供重要依据。具体监控指标包括 QPS、响应时间、流控降级接口数等。

1.  登录 [AHAS 控制台](https://ahas.console.aliyun.com/)，在控制台左上角选择应用接入的地域。
2.  在控制台左侧导航栏中选择**流量防护** \> **应用防护**。
3.  在应用列表页面单击目标应用的资源卡片。
4.  在应用概览页面查看应用的限流指标详情、QPS 热力图、集群的平均 RT 和不同 SQL 语句执行的 Top 情况（包括请求 QPS Top、拒绝 QPS Top、RT Top，以及对应的单机 Top 数据） 。

    ![慢 SQL_应用概览](../images/p58336.png "应用概览")

5.  在左侧导航栏单击**监控详情**，在监控详情页面查看每条 SQL 语句的调用及执行情况。

    ![慢 SQL-监控详情](../images/p58343.png "监控详情")


## 步骤三：配置慢 SQL 防护规则

根据 AHAS 自动识别的 SQL 语句，可以对出现慢 SQL 的应用配置线程数维度的流控或降级规则，当出现慢 SQL 调用时限制同一时刻执行的 SQL 数量，防止过多的慢 SQL 语句执行把资源耗尽。

**流控规则**

针对慢 SQL 防护的流控规则有直接模式和关联模式，具体配置步骤请参见[配置流控规则](/cn.zh-CN/流量防护/应用防护/配置规则/配置流控规则.md)。

-   **直接模式**：在该模式下，阈值配置为当前 SQL 资源，超过设置的值后多余的请求将被拒绝。

    ![慢 SQL-直接模式](../images/p58355.png "直接模式")

-   **关联模式**：阈值配置为关联SQL资源，关联的资源请求超过设置的之后，该资源的调用将被拦截。

    ![关联模式](../images/p58380.png "关联模式")


**降级规则**

慢 SQL 防护的还可以使用降级规则，根据 SQL 执行的 RT 设置对应的阈值以及时间窗口，超过指定的 RT 值后在时间窗口内 SQL 执行将被降级，抛出包装好的异常。具体操作步骤请参见[配置降级规则](/cn.zh-CN/流量防护/应用防护/配置规则/配置降级规则.md)。

![降级规则](../images/p58384.png "降级规则")

资源被流控降级后会报 `BlockException` 类异常（限流会抛流控异常 FlowException，降级会抛出降级异常 DegradeException），您可以根据异常信息进行后续业务处理。

