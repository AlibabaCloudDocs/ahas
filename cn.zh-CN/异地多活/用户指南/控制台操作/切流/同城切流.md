# 同城切流

MSHA的核心功能是切流。本文将介绍在同城中如何创建切流任务并查看切流详情。

-   完成[全局配置引导](/cn.zh-CN/异地多活/用户指南/控制台操作/多活配置/全局配置引导.md)。
-   按需完成各层配置：
    -   [配置接入层](/cn.zh-CN/异地多活/用户指南/控制台操作/多活配置/配置接入层.md)。
    -   [同步DRDS多活实例](/cn.zh-CN/异地多活/用户指南/控制台操作/多活配置/配置数据层/同步DRDS多活实例.md)。

## 创建切流工单

1.  登录[MSHA控制台](https://msha.console.aliyun.com)。

2.  在左侧导航栏单击**同城切流列表**，并在左上角选择目标**命名空间**。

3.  在同城切流列表页面右上角单击**切流**。

4.  在切流任务页面选择以下任意一种方式完成规则调整。

    -   **比例切流**
        1.  选择**切流方式**为**比例切流**。
        2.  选择**单元**。
        3.  在切流调整中，设置各个区域的切流比例。也可单击**一键切零**，比例归为零。
        4.  单击**确定**。
    -   **精准切流**
        1.  选择**切流方式**为**精准切流**。
        2.  选择**单元**。
        3.  选择**切流调整**的规则。
        4.  单击单元**操作**列的**修改**，在**中心单元**面板中输入访问中心单元的流量名单，单击**+ 添加**，可添加多个要切流的精准名单。完成后单击**确定**。
5.  单击**确定**，进入**切流检查**。

6.  在**切流检查**区域查看切流检查，待所有检查项均通过后，单击**切流**。

    **说明：** 若有检查项检查不通过，可在该检查项右侧单击**重试**或**跳过**。**跳过**功能一般用于紧急切流场景，请谨慎使用。

    ![切流检查公共云](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/7247911061/p169393.png)


## 查看切流详情

创建切流任务后，MSHA开始进行切流工作。完成切流需要进行以下3个过程：

**说明：** 若未启用某多活组件，则切流详情中不会有对应的步骤和展示内容。

1.  更新规则。

    MSHA使用ACM向业务系统推送切流态路由规则，业务系统中依赖的MSHA-SDK，将根据切流态路由规则进行路由。

    ![切流任务](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/7247911061/p169421.png)

    **说明：** 若推送规则失败，则单击**重试**进行重试，MSHA将在2小时内定时自动重试，如果超时仍未成功则切流工单进入**异常**状态并回滚重推基线规则。

2.  各层切流。

    同时进行接入层和数据层切流。

    -   接入层切流。MSHA将执行各单元流量比例推送和各单元化路由规则推送。

        ![接入层切流](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8247911061/p169423.png)

        **说明：** 若推送规则失败，则单击**重试**进行重试，MSHA将在2小时内定时自动重试，如果超时仍未成功则切流工单进入**异常**状态。

    -   数据层切流。MSHA自动获取数据层的实例库DTS同步延迟情况。业务系统中依赖的MSHA-SDK也会根据同步延时策略，进行相关的控制（禁写、禁更新、忽略）。当所有实例库DTS同步延迟为0s时，系统自动进入下一步骤**切流后置任务**。
3.  切流后置任务。

    MSHA将进行全镜像关闭，即关闭DTS数据库同步的校验功能。并使用ACM向业务系统推送切流终态路由规则。业务系统中依赖的MSHA-SDK，将根据终态路由规则进行路由，并结束同步延时策略的相关控制（禁写、禁更新、忽略）。

    ![切流后置任务](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8247911061/p169424.png)


