---
keyword: [降级规则, 熔断规则, 弱依赖降级]
---

# 配置熔断规则

AHAS的熔断规则可以监控应用内部或者下游依赖的响应时间或异常比例，当达到指定的阈值时立即降低下游依赖的优先级。在指定的时间内，系统不会调用该不稳定的资源，避免应用受到影响，从而保障应用高可用性。当指定时间过后，再重新恢复对该资源的调用。

## 前提条件

已在AHAS应用防护中接入应用，具体操作请参见[接入应用方式](/cn.zh-CN/流量防护/应用防护/接入应用/接入应用方式.md)。

## 背景信息

除了流量控制以外，对调用链路中不稳定的方法或者下游依赖进行熔断也是重要措施之一。由于调用关系的复杂性，如果调用链路中的某一环节出现了错误，会导致这个请求失败，甚至会放大不稳定性，导致整个链路无法正常服务。熔断功能会在调用链路中某个方法出现不稳定时（例如某方法出现Timeout或异常比例升高），对这个方法的调用进行限制，让请求快速失败，避免此错误影响整个链路。关于熔断的相关信息，请参见[熔断结构图](https://github.com/Netflix/Hystrix/wiki)。

熔断规则配置通常用于弱依赖降级场景，更多信息，请参见[弱依赖降级](/cn.zh-CN/流量防护/应用防护/参考信息/应用防护方法/弱依赖降级.md)。

## 功能入口

1.  登录[AHAS控制台](https://ahas.console.aliyun.com/)。
2.  在AHAS控制台左上角，选择应用接入的**地域**。
3.  在控制台左侧导航栏中选择**流量防护** \> **应用防护**。
4.  在应用防护页面单击目标应用卡片。
5.  选择以下任意一种方法进入熔断规则的设置页面：
    -   在左侧导航栏单击应用概览，然后单击页面下方目标接口**操作**列中的**熔断**。
    -   在左侧导航栏单击**接口详情**，在接口详情页面单击资源卡片右上角![新增](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0322119951/p135195.png)或![管理规则](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0322119951/p135192.png)的图标，在管理规则对话框中单击目标方案的页签，然后单击**熔断规则**页签，单击新增熔断规则。
    -   在左侧导航栏单击规则设置，单击目标方案的页签，然后单击熔断规则页签，在页面右上角单击**新增熔断规则**。
6.  在新增熔断规则或新增规则的对话框中配置规则信息。

    **说明：** 慢调用比例、统计窗口时长、最小请求数目等配置项需要Java SDK版本≥1.6.0或Java Agent版本≥1.7.5。


## 常用场景1：慢调用熔断示例

例如调用第三方服务，但响应时间太慢，会影响当前接口，所以对其进行熔断操作。

在新增熔断规则或新增规则对话框中配置以下示例规则信息。

|参数|示例值|描述|
|--|---|--|
|**接口名称**|test|接口名称。|
|**统计窗口时长**|1|统计时长为1秒。|
|**阈值类型**|慢调用比例|选择以慢调用比例作为阈值。|
|**慢调用RT**|1000|超过1000 ms则判定为慢请求。|
|**降级阈值**|80%|触发熔断的慢调用比例阈值为80%。|
|**熔断时长**|10|熔断时长有10秒。|
|**最小请求数目**|10|触发熔断的最小请求数目为10。|
|**熔断恢复策略**|单次探测恢复|经过熔断时长后，熔断器会对接下来的一个请求进行探测，若该请求符合预期（不为慢调用或没有异常），则结束熔断；否则重新回到熔断阶段。|

规则开启后，在统计时长1秒内，当请求数目大于10，并且慢调用的比例大于80%的时候，则在接下来10秒的熔断时长内，请求都会快速失败。经过10秒后熔断器会进入探测恢复状态，若接下来的一个请求响应时间小于设置的1000 ms则结束熔断，若大于1000 ms则会再次被熔断。

![creat_demotion_rule_example](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4173281161/p103439.png)

## 常用场景2：异常熔断示例

例如第三方内容展示时，系统会出现异常，当异常比例较高时，可以对其进行熔断操作，以保证更好的用户体验。

在新增熔断规则或新增规则对话框中配置以下示例规则信息。

|参数|示例值|描述|
|--|---|--|
|**接口名称**|test|接口名称。|
|**统计窗口时长**|1|统计时长为1秒。|
|**阈值类型**|异常比例|选择以异常比例作为阈值。|
|**降级阈值**|80%|触发熔断的异常比例阈值为80%。|
|**熔断时长**|10|熔断时长有10秒。|
|**最小请求数目**|10|触发熔断的最小请求数目为10。|
|**熔断恢复策略**|单次探测恢复|经过熔断时长后，熔断器会对接下来的一个请求进行探测，若该请求符合预期（不为慢调用或没有异常），则结束熔断；否则重新回到熔断阶段。|

规则开启后，在统计时长1秒内，当请求数目大于10，并且异常的比例大于80%的时候，则在接下来10秒的熔断时长内，请求都会快速失败。经过10秒后熔断器会进入探测恢复状态，若接下来的一个请求没有异常则结束熔断，否则会再次熔断。

![creat_demotion_rule_example2](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4173281161/p103454.png)

## 更多信息

新增熔断规则或新增规则对话框的参数说明如下。

|参数|描述|
|--|--|
|**接口名称**|适用该规则的应用资源。|
|**统计窗口时长**|统计的时间窗口长度，取值范围为1秒~120分钟。|
|**最小请求数目**|触发熔断的最小请求数目，若当前统计窗口内的请求数小于此值，即使达到熔断条件规则也不会触发。|
|**阈值类型**|选择以**慢调用比例**或**异常比例**作为阈值。-   选择以**慢调用比例**作为阈值，需要设置允许的**慢调用RT**（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。

在**降级阈值**中设置触发熔断的慢调用比例。规则开启后，在单位统计时长内请求数目大于设置的**最小请求数目**，并且慢调用的比例大于阈值，则接下来的**熔断时长**内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态，若接下来的一个请求响应时间小于设置的**慢调用RT**则结束熔断，若大于设置的**慢调用RT**则会再次被熔断。

-   选择以**异常比例**作为阈值，需要在**降级阈值**中设置触发熔断的异常比例。

规则开启后，在单位统计时长内业务异常数目大于设置的**最小请求数目**，并且异常的比例大于阈值，则接下来的**熔断时长**内请求会自动被熔断。 |
|**熔断时长**|即熔断触发后持续的时间。资源进入熔断状态后，在配置的熔断时长内，请求都会快速失败。|
|**熔断恢复策略**|熔断器进入恢复阶段（半开启状态）的恢复策略。-   **单次探测恢复**：经过熔断时长后，熔断器会对接下来的一个请求进行探测，若该请求符合预期（不为慢调用或没有异常），则结束熔断；否则重新回到熔断阶段。
-   **渐进式恢复**：需要设置**恢复阶段数**和**每步最小通过数目**。

    -   经过熔断时长后，熔断器按照设定的恢复阶段数进行渐进式恢复，若该阶段内请求达到一定量即每步最小通过数目，则触发检查。检查的请求若都未超过阈值，则逐步提高允许通过的请求比例，直到请求完全恢复；若某一步的指标超出阈值，则重新回到熔断阶段。
    -   请求比例T=100/恢复阶段数N，则第一阶段请求比例为T，第二阶段为2T……直到100%。
    -   例如恢复阶段数为3，每步最小通过数目为5，则三个阶段分别按照33%、67%和100%的比例放入请求，当每阶段的请求数目大于等于5时进行检查，若请求的指标未超阈值则进入下一恢复阶段，直至完全恢复。
**说明：** 渐进式恢复策略功能需要Java SDK版本≥1.6.2。 |

