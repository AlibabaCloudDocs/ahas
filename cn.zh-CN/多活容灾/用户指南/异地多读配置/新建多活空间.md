---
keyword: [异地多读, MSHA, 多活容灾]
---

# 新建多活空间

接入MSHA前，您需要在控制台配置各资源的信息，用于接入层的使用。本文介绍新建异地多读空间的操作步骤。

## 步骤一：添加多活空间

多活命名空间MSHA Namespace，是一个逻辑租户的概念。可以对MSHA管控配置和数据的逻辑隔离，具体添加步骤如下。

1.  登录[AHAS控制台](https://ahas.console.aliyun.com)。

2.  在控制台左侧导航栏中选择**多活容灾**。

3.  在左侧导航栏选择**基础配置** \> **新建多活空间**，在**新建多活空间**页面完成以下配置。

    1.  填写**多活空间名称**，例如交易单元化的正式环境，导购单元化的测试环境。

    2.  在**业务类型**下拉列表中选择多活空间的业务类型。

    3.  选择**多活类型**为**异地多读**。

    4.  选择需要启用的多活组件。

        **说明：** 目前异地多读仅支持异地接入层组件。

    5.  配置接入层路由标提取方式。

        可选择从**HTTP Header**或**HTTP Cookie**中提取，需配置提取的Key关键字，例如routerId。

        Key的命名规范：

        -   如果路由参数在Header，Key的命名规范是数字、字母、中划线（-），以字母开头。
        -   如果路由参数在Cookie，Key的命名规范是数字、字母、下划线（\_），以字母开头。
        **说明：** 若配置了路由标提取方式，系统则按照路由标进行单元分流；若未配置路由标提取方式，系统则按照比例进行单元分流。

4.  单击**下一步**。


## 步骤二：添加单元

单元是据业务特点在逻辑上分成的几个逻辑数据中心，核心业务在这个数据中心实现自流转。

1.  单击**+添加单元**或**+修改**，为每个单元配置相关信息，然后单击**确定**。

    |参数|描述|
    |--|--|
    |**单元标**|单元的标识。例如中心单元的单元标为Center。|
    |**单元名称**|单元的名称。|
    |**单元角色**|选择配置的单元为中心单元、备中心单元或多活单元。|
    |**包含可用区**|单元对应的可用区。|
    |**ACM**|（可选）单击**添加ACM**，可添加各云账号下的ACM空间名称和空间ID，用于MSHA规则推送。|
    |**单元格**|（可选）单击**添加单元格（Cell）**，可添加单元格相关信息。|
    |**接入层集群**|选择在单元绑定的接入层集群。若当前账号下没有集群，请单击**新增集群**，并在集群配置页面新增集群。|

2.  单击**下一步**。


## 步骤三：添加路由规则

路由标解析规则用于定义如何解析路由标的逻辑。

1.  在右侧面板中设置**路由标解析规则ID**、**路由标解析规则名称**等信息。

    MSHA会为您生成一个默认的路由标解析规则，若您在[步骤一：添加多活空间](#section_41x_4v3_z8s)中填写了路由标，则可以按需修改。

    ![路由解析规则.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9714700161/p211179.png)

2.  在**测试路由标解析**下方输入测试内容，并单击**测试**，查看测试结果是否符合预期。

    单击**测试**验证解析规则能否解析路由参数，显示结果即为提取成功，否则提示错误信息。

    以下示例路由参数为业务系统的用户ID，这里输入任意数字格式的UserID，单击**测试**后出现跟输入值一致的结果，说明YAML规则能正确提取出路由标。

    ![路由标解析2.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6594700161/p211194.png)

3.  在右侧面板单击**确定**。

4.  选择配置范围规则或精准规则。

    -   配置范围规则
        1.  选择路由规则为**范围**。
        2.  使用以下任意方式配置范围流量规则。
            -   拖动中心单元或普通单元区段选择器的滑块来改变流量分配。
            -   编辑中心单元和普通单元的流量区间。

                **说明：** 中心单元的流量区间与普通单元的流量区间需连续且不重复。例如中心单元流量区间为\[0,3609\]，则普通单元为\[3609,9999\]。

    -   配置精准规则
        1.  选择路由规则为**精准**。
        2.  配置中心单元精准名单。
            1.  单击**中心单元**右侧的**创建精准名单**。
            2.  在**中心单元**面板中依次输入访问中心单元的名单并单击**+ 添加**。
            3.  在**中心单元**面板中单击**确定**。
        3.  配置普通单元精准名单。
            1.  选择路由规则为**精准**。
            2.  单击**普通单元**右侧的**创建精准名单**。
            3.  在**普通单元**面板中依次输入访问普通单元的名单并单击**+ 添加**。
            4.  在**中心单元**面板中单击**确定**。
5.  单击**确定**。

    完成异地多读的多活空间配置，在路由规则区域展示了两个单元的路由规则：

    -   若配置了路由标，则按照路由标分流。
    -   若未配置路由标，则按照每个单元的比例进行分流。

创建完成后，在左侧导航栏选择**首页**，在顶部选择**命名空间**，查看对应多活空间下的路由规则展示跟配置一致，则证明配置成功。

**说明：** 异地多读区域会展示**接入层分流开关**的状态，默认是开启。

![异地多读1.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1108899061/p210303.png)

