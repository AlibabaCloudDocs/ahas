# 同城切流

MSHA的核心功能是切流。本文将介绍在同城中如何创建切流任务并查看切流详情。

-   [新建命名空间](/cn.zh-CN/多活容灾/用户指南/同城多活配置/新建命名空间.md)
-   [配置MSFE](/cn.zh-CN/多活容灾/用户指南/同城多活配置/配置MSFE.md)
-   [配置HSF](/cn.zh-CN/多活容灾/用户指南/同城多活配置/服务层配置/配置HSF.md)

## 创建切流工单

1.  登录[AHAS控制台](https://ahas.console.aliyun.com)。

2.  在控制台左侧导航栏中选择**多活容灾**。

3.  在左侧导航栏选择**切流** \> **同城切流**，并在顶部选择目标命名空间。

4.  在同城切流页面，单击**切流**。

5.  在切流详情页面选择以下任意一种方式完成规则调整。

    -   **比例切流**
        1.  选择**切流方式**为**比例切流**。
        2.  从**单元**下拉列表中选择目标单元。
        3.  在切流调整中，设置各个区域的切流比例。也可单击**一键切零**，比例归为零。

            **说明：** 所有单元值切流比例总和为100%。

        4.  单击**确定**。
    -   **精准切流**
        1.  选择**切流方式**为**精准切流**。
        2.  从**单元**下拉列表中选择目标单元。
        3.  选择**切流调整**的规则。可选择从**HTTP Header**或**HTTP Cookie**中提取，需配置提取的Key关键字，例如routerId。
        4.  单击单元格**操作**列的**修改**，在**修改**面板中添加各单元精准路由名单，单击**+ 添加**，可添加多个要切流的精准名单。完成后单击**确定**。
6.  单击**确定**，进入**切流检查**。

7.  在**切流检查**区域查看切流检查，待所有检查项均通过后，单击**切流**。

    **说明：** 若有检查项检查不通过，可在该检查项右侧单击**重试**或**跳过**。**跳过**功能一般用于紧急切流场景，请谨慎使用。


## 查看切流详情

创建切流任务后，MSHA开始进行切流工作。完成切流需要进行以下3个过程。

**说明：** 若未启用某多活组件，则切流详情中不会有对应的步骤和展示内容。

1.  更新规则。

    MSHA使用ACM向业务系统推送切流态路由规则，业务系统中依赖的MSHA-SDK，将根据切流态路由规则进行路由。

    **说明：** 若推送规则失败，则单击**重试**进行重试，MSHA将在2小时内定时自动重试，如果超时仍未成功则切流工单进入**异常**状态并回滚重推基线规则。

2.  各层切流。

    MSHA将执行各单元格流量比例和精准路由规则的推送。

    **说明：** 若推送规则失败，则单击**重试**进行重试，MSHA将在2小时内定时自动重试，如果超时仍未成功则切流工单进入**异常**状态。

3.  切流后置任务。

    MSHA将进行前镜像关闭，即关闭DTS数据库同步的校验功能。并使用ACM向业务系统推送切流终态路由规则。业务系统中依赖的MSHA-SDK，将根据终态路由规则进行路由，并结束同步延时策略的相关控制（禁写、禁更新、忽略）。


