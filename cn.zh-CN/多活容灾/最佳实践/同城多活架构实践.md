---
keyword: [同城多活, 最佳实践]
---

# 同城多活架构实践

多活容灾MSHA（Multi-Site High Availability）是一个云原生的多活容灾架构解决⽅案。本文介绍同城多活容灾架构的建设原则和难点，并通过一个电商业务案例，介绍如何基于MSHA来快速、无侵入的帮助业务实现同城多活容灾架构。

## 同城多活架构介绍

同城多活（DB主备）的架构图如下：

![同城多活架构1.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4347231261/p275052.png)

同城多活架构包含以下主要特征：

-   应用可用区级多活。
-   数据库跨可用区主备。
-   RPO：分钟级（AZ级故障）。
-   RTO：分钟级（AZ级故障）。

**应用场景：**

-   针对可用区级的故障、灾难，期望业务具备分钟级恢复能力的场景。
-   应用多可用区部署的情况下，期望RPC调用可用区内封闭，以避免跨可用区网络请求带来的RT增长。

**建设原则：**

-   保证冗余。
-   保持对等。
-   保持封闭。

**建设难点：**

-   流量管理难度高。
    -   当发生可用区级故障、灾难时：
        -   需具备HTTP、HTTPS流量的可用区级动态调配分流能力。
        -   需具备对故障AZ的RPC、MQ、任务调度流量切零能力。
    -   如果业务RT敏感，需具备可用区内流量封闭的能力以避免跨可用区的网络传输带来的RT增长。
-   统一管控难度大。
    -   需对接支持众多的云产品和开源框架。
    -   切零规则、流量可用区内封闭规则、环境隔离规则、甚至异地多活路由规则共存的情况下，需保证规则的优先级、兼容性和冲突解决策略。
-   业务无侵入难度大：要实现HTTP、RPC、MQ、任务调度等流量管控能力，通常需要业务应用配合改造，对业务代码侵入大。

## 业务背景信息

![电商业务.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5347231261/p275058.png)

**本示例的电商业务包含以下应用：**

-   frontend：入口WEB应用，负责和用户交互。
-   cartservice：购物车应用。记录用户的购物车数据，使用自建的Redis。
-   productservice：商品应用。提供商品、库存服务，使用RDS MySQL。

**技术栈：**

-   SpringBoot。
-   RPC框架：SpringCloud，注册中心使用自建的Eureka。

**体验地址：**

-   多活容灾控制台：
    1.  登录[AHAS控制台](https://ahas.console.aliyun.com)。
    2.  在控制台左侧导航栏单击**多活容灾**。
    3.  在顶部菜单栏，**命名空间**选择**官方示例命名空间**。
-   电商业务页面：[Demo1](http://47.99.241.9)或者[Demo2](http://39.97.187.41)。

## 案例背景：一次故障的发生

本示例的电商业务已自行进行了同城容灾能力建设，在杭州的多个可用区进行应用的对等部署，并自行实现了可用区级粒度的入口流量控制。但因为一次线上可用区级故障，才发现将故障可用区的HTTP流量切换到其他可用区后，下游的RPC、MQ调用仍然有概率访问到故障可用区内的机器，业务仍然无法使用，导致电商页面长时间无法访问，甚至电商业务瘫痪。

虽然故障最终得以解决，但故障导致的客户流失和企业口碑影响，对快速发展的业务造成不小的打击，迫使企业开始重视同城多活容灾能力的建设，以及定期做故障演练确保故障恢复能力的有效性。

## 同城多活架构改造

基于MSHA多活容灾解决方案，您可以快速地对业务进行同城多活容灾架构建设。

多活改造和MSHA接入包括以下方面：

1.  开通并配置MSHA需要启用的多活模块。具体操作，请参见[开通并配置MSHA](/cn.zh-CN/多活容灾/用户指南/开通并配置MSHA.md)。

2.  创建同城多活的命名空间，选择容灾架构类型为同城多活，将应用部署所在的2个可用区定义为2个单元格。具体操作，请参见[新建命名空间](/cn.zh-CN/多活容灾/用户指南/同城多活配置/新建命名空间.md)。

3.  安装MSHA探针。具体操作，请参见[管理MSHA探针](/cn.zh-CN/多活容灾/用户指南/管理MSHA探针.md)。

4.  配置接入层MSFE。具体操作，请参见[配置MSFE](/cn.zh-CN/多活容灾/用户指南/同城多活配置/配置MSFE.md)。

    改造后的应用架构如下图所示：

    ![同城多活架构改造后.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5044331261/p275083.png)


## 复现故障

基于MSHA完成同城多活架构建设后，还需验证容灾能力是否符合预期。接下来将历史故障进行复现，通过制造真实的故障来验证容灾恢复能力。

1.  **演练准备。**

    1.  登录[AHAS控制台](https://ahas.console.aliyun.com)。

    2.  在控制台左侧导航栏单击**多活容灾**。

    3.  在左侧导航栏单击**监控大盘**，在顶部菜单栏，选择**命名空间**为**官方示例命名空间**。

    4.  在同城多活区域，查看业务监控指标。

        **说明：** 基于MSHA流量监控或其他监控能力，确定业务稳态的监控指标，以便在故障发生时判断故障影响面以及在故障恢复后判断业务的实际恢复情况。

        ![监控大盘.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5044331261/p275088.png)

        演练预期：电商首页展示的查询链路对商品应用是强依赖，强依赖故障将导致业务不可用，且故障的爆炸半径应该控制在单元格内。

    5.  创建故障演练。

        创建杭州单元格B下的商品应用故障演练（例如网络丢包）。具体操作，请参见[创建演练](/cn.zh-CN/故障演练/开始演练/创建演练.md)。

2.  **故障注入。**

    1.  在多活容灾的监控大盘页面同城多活区域，查看故障演练前配置的路由规则。

        本示例中杭州地域的各个单元格流量比例为50%。

        ![路由规则1.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5044331261/p275096.png)

        示例的MSHA商城商品应用链路如下图所示，UserID为1000的用户路由到单元格B。

        ![查看链路1.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5044331261/p275098.png)

    2.  对杭州域单元格B下的商品应用注入故障。

        1.  在[AHAS控制台](https://ahas.console.aliyun.com)的左侧导航栏选择**故障演练** \> **我的空间**。
        2.  在我的空间单击演练准备中创建的演练，然后单击**演练**。
        3.  在开始执行演练对话框中，单击**确定**。

            ![故障注入2.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5044331261/p275113.png)

            若故障注入成功，打开电商首页，有概率出现访问异常，符合预期。

            ![访问失败.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2416078061/p204913.png)


## 切流恢复

接下来将验证故障场景下的容灾恢复能力。在杭州单元格B的商品应用发生故障的情况下，可使用MSHA切流功能将流量全部切换到另外的单元格，进行快速业务恢复（这里区别于传统的思路，不是去排查、处理和修复故障，而是立即使用切流进行恢复，将业务恢复和故障恢复解耦）。

容灾切换预期：将100%的流量比例都切换到单元格I，切流后业务完全恢复，不受单元格B的故障影响。

1.  登录[AHAS控制台](https://ahas.console.aliyun.com)。

2.  在控制台左侧导航栏中选择**多活容灾**。

3.  在左侧导航栏选择**基础配置** \> **命名空间**，在顶部菜单栏选择**官方示例命名空间**。

4.  在多活容灾的左侧导航栏选择**切流** \> **同城切流**。

5.  在同城切流页面，单击**切流**。

6.  在切流详情页面的规则调整区域，选择**切流方式**为**比例切流**，从**单元**下拉列表中选择**杭州中心单元**，单击**杭州中心单元-单元格**B的**一键切零**。

    ![同城切流.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6044331261/p275114.png)

7.  单击**确定**。在切流检查区域检查完成后，单击**切流**。

8.  在切流任务页面，查看**工单状态**为**切流完成**。表示切流已成功。

    ![切流完成.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6418331261/p275115.png)

    **验证结果**：

    1.  刷新MSHA商城首页，多次访问均能正常展示，符合预期。
    2.  通过查看实际调用链路，首页的流量始终访问到杭州单元格I中，不受单元格B故障的影响，符合预期。

        ![查看链路2.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6418331261/p275118.png)


## 功能演示

故障注入和切流恢复的功能演示如下。



## 后续步骤

您还需要进行以下操作：

-   终止注入故障。具体操作，请参见[停止演练](/cn.zh-CN/故障演练/开始演练/停止演练.md)。
-   反馈演练结果，记录演练识别到的风险问题。具体操作，请参见[反馈演练结果](/cn.zh-CN/故障演练/开始演练/停止演练.md)。
-   回切流量，将单元格B和单元格I的流量比例，通过再次切流恢复到各50%（演练前的状态）。具体操作，请参见[同城切流](/cn.zh-CN/多活容灾/用户指南/切流/同城切流.md)。
-   在控制台的监控大盘，查看业务的稳态指标已恢复。

